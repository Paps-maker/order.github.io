<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="icon" type="image/png" href="img/ice.jpg">
<title>Fast Food & Ice Cream SipDrip</title>
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg:#fff7f0; --card:#fff; --accent:#ff4d4d; --accent-light:#ffd633; --muted:#333; --danger:#dc3545; --success:#28a745;
}
*{box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:0;}
body{background:var(--bg);}
header{background:linear-gradient(90deg,#ff4d4d,#ffd633);color:#fff;font-weight:700;font-size:22px;padding:20px;text-align:center;border-bottom-left-radius:12px;border-bottom-right-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.15);position:relative;}
header::after{content:"";background:url('https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=800&q=80') no-repeat center/cover;opacity:0.15;position:absolute;top:0;left:0;width:100%;height:100%;border-bottom-left-radius:12px;border-bottom-right-radius:12px;z-index:0;}
.top-controls{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:15px;}
.top-controls input, .top-controls select{padding:8px;border-radius:8px;border:1px solid #ddd;width:200px;}
.top-buttons{display:flex;gap:10px;justify-content:center;margin:10px;}
.top-buttons button{background:var(--accent);color:#fff;padding:10px 18px;border:none;border-radius:50px;font-weight:700;cursor:pointer;transition:0.2s;}
.top-buttons button:hover{background:#e63946;}
.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;padding:15px;}
.product-card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 6px 12px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition: transform 0.2s, box-shadow 0.2s;}
.product-card:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,0.15);}
.product-card img{width:100%;height:auto;object-fit:contain;background:#fff7f0;padding:10px;border-radius:12px;}
.product-info{padding:12px;flex:1;display:flex;flex-direction:column;justify-content:space-between;}
.product-info h4{margin-bottom:6px;color:var(--muted);font-size:16px;font-weight:600;}
.product-info p{margin-bottom:10px;color:var(--accent);font-weight:700;font-size:15px;}
.product-info .qty-container{display:flex;align-items:center;gap:6px;margin-bottom:10px;}
.product-info .qty-container button{width:28px;height:28px;border:none;background:#ffd633;font-size:16px;border-radius:50%;cursor:pointer;font-weight:700;color:#333;transition:0.2s;}
.product-info .qty-container button:hover{background:var(--accent);color:#fff;}
.product-info .qty-container span{min-width:20px;text-align:center;display:inline-block;}
.product-info button.add-cart{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:12px;cursor:pointer;font-weight:700;font-size:14px;transition:0.2s;}
.product-info button.add-cart:hover{background:#e63946;}
.cart-summary-btn{position:fixed;bottom:15px;right:15px;background:var(--accent);color:#fff;padding:12px 18px;border:none;border-radius:50px;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,0.2);cursor:pointer;display:flex;align-items:center;gap:8px;transition:0.2s;}
.cart-summary-btn:hover{background:#e63946;}
.cart-count{background:#fff;color:var(--accent);padding:2px 6px;border-radius:50%;font-size:12px;}
#orderModal,#checkoutModal,#favoritesModal,#myOrdersModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#fff;width:90%;max-width:500px;border-radius:16px;overflow:hidden;max-height:90vh;}
.modal-header{background:var(--accent);color:#fff;padding:14px;font-weight:700;font-size:18px;}
.modal-body{padding:14px;max-height:60vh;overflow-y:auto;}
.modal-body table{width:100%;border-collapse:collapse;margin-bottom:10px;}
.modal-body th,td{padding:8px;text-align:left;border-bottom:1px solid #eee;font-size:14px;}
.modal-footer{padding:12px;text-align:right;border-top:1px solid #eee;}
.modal-footer button{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:0.2s;}
.modal-footer button:hover{background:#e63946;}
.qty-edit{display:flex;align-items:center;gap:4px;}
.qty-edit button{width:28px;height:28px;border:none;background:#ffd633;font-size:14px;border-radius:50%;cursor:pointer;font-weight:700;transition:0.2s;}
.qty-edit button:hover{background:var(--accent);color:#fff;}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;margin-bottom:10px;}
@media(max-width:480px){.modal-content{width:95%;}.modal-body table th,.modal-body table td{font-size:12px;padding:6px;}.product-card img{height:auto;object-fit:contain;}}
/* small helper so the WhatsApp button next to Place Order looks good in modal footer */
.modal-footer .whatsapp-btn{
  background:#25D366;color:#fff;padding:8px 12px;border-radius:8px;border:none;margin-left:8px;cursor:pointer;font-weight:700;
}
</style>
</head>
<body>

<header>üçî Fast Food & Ice Cream Menu üç¶</header>

<!-- Search & Category Filter -->
<div class="top-controls">
  <input type="text" id="searchInput" placeholder="Search products...">
  <select id="categoryFilter">
    <option value="all">All Categories</option>
    <option value="Burgers">Burgers</option>
    <option value="Ice Cream">Ice Cream</option>
    <option value="Drinks">Drinks</option>
    <option value="Sides">Sides</option>
  </select>
</div>

<div class="top-buttons">
  <button id="viewCartBtn">üõí Cart (<span id="cartCount">0</span>)</button>
  <button id="viewFavoritesBtn">‚≠ê Favorites</button>
  <button id="viewOrdersBtn">üì¶ My Orders</button>
  <!-- Loyalty Button -->
  <button id="viewPointsBtn" style="background:#ffd633;color:#333;padding:8px 14px;border:none;border-radius:12px;font-weight:700;">
    üéØ My Points
  </button>
 

</div>
  <button id="joinWhatsAppBtn" onclick="window.open('https://chat.whatsapp.com/JgL6CVd9giGHfZMsUtqMDU', '_blank')" 
        style="background:#25D366; color:white; padding:8px 14px; border:none; border-radius:12px; font-weight:700; display:flex; align-items:center; gap:8px;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" 
       alt="WhatsApp Icon" style="width:20px; height:20px;">
  Join our WhatsApp Group
</button>


<!-- ‚úÖ Floating SipDrip AI Assistant -->
<button id="sipdripAIButton"
  style="position:fixed; bottom:20px; right:20px; background:#FFA94D;
         color:#fff; border:none; border-radius:50%; width:60px; height:60px;
         font-size:24px; cursor:pointer; box-shadow:0 6px 12px rgba(0,0,0,0.3);
         z-index:9999;">ü§ñ</button>

<!-- ‚úÖ Chat Window -->
<div id="sipdripChat"
     style="display:none; position:fixed; bottom:90px; right:20px; width:340px;
            height:350px; background:#fff; border-radius:12px; overflow:hidden;
            box-shadow:0 8px 20px rgba(0,0,0,0.3); z-index:9999;
            display:flex; flex-direction:column; font-family:Arial, sans-serif;">
  <div style="background:#FFA94D; color:#fff; padding:10px; font-weight:700;
              display:flex; justify-content:space-between; align-items:center;">
    <span>üçß SipDrip AI Assistant</span>
    <button id="closeAIChat"
            style="background:none; border:none; color:#fff;
                   font-size:18px; cursor:pointer;">‚úñ</button>
  </div>

  <div id="aiChatContent"
       style="flex:1; padding:10px; overflow-y:auto; background:#f9f9f9;"></div>

  <div style="display:flex; border-top:1px solid #ddd;">
    <input id="aiUserInput" type="text" placeholder="Ask me anything..."
           style="flex:1; border:none; padding:10px; outline:none;">
    <button id="aiSendBtn"
            style="background:#FFA94D; border:none; color:#fff;
                   padding:0 16px; cursor:pointer;">Send</button>
  </div>
</div>

<script>
// --- Selectors ---
const aiBtn = document.getElementById('sipdripAIButton');
const aiChat = document.getElementById('sipdripChat');
const closeAIChat = document.getElementById('closeAIChat');
const aiSendBtn = document.getElementById('aiSendBtn');
const aiUserInput = document.getElementById('aiUserInput');
const aiChatContent = document.getElementById('aiChatContent');

// --- Toggle Chat ---
aiBtn.onclick = () => aiChat.style.display = 'flex';
closeAIChat.onclick = () => aiChat.style.display = 'none';

// --- Add Message Helper ---
function addAIMessage(text, sender = 'bot', img = null) {
  const msg = document.createElement('div');
  msg.style.margin = '10px 0';
  msg.style.display = 'flex';
  msg.style.flexDirection = sender === 'user' ? 'row-reverse' : 'row';
  msg.innerHTML = `
    <div style="background:${sender === 'user' ? '#FFA94D' : '#eee'};
                color:${sender === 'user' ? '#fff' : '#333'};
                padding:8px 12px; border-radius:10px; max-width:80%;">
      ${text}
      ${img ? `<br><img src="${img}" style="margin-top:8px; border-radius:8px; width:100%; max-width:220px;">` : ''}
    </div>
  `;
  aiChatContent.appendChild(msg);
  aiChatContent.scrollTop = aiChatContent.scrollHeight;
}

// --- Menu Data ---
const menu = {
  icecream: [
    { name: "Mango Ice Cream", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759774914903_mango.jpg?alt=media&token=7b97e539-929c-42c3-8c12-77a88ae68f13" },
    { name: "Vanilla Pistachio", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759665255984_pist.jpg?alt=media&token=2caae2d0-304c-44f7-bcf1-ed2282c8e80d" },
    { name: "Vanilla BlueBerry", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759500370487_blue.jpg?alt=media&token=dd404255-5420-49a4-883c-e28b0dd1da62" },
    { name: "Vanilla Chocolate", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759500566899_cho.jpg?alt=media&token=03b8dae6-1c44-49b7-89b7-6df72356572f" },
    { name: "Vanilla Strawberry per scoop", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759500009215_ice7.jpg?alt=media&token=b79c9490-867e-44b1-b259-0eaa12054e91" },
    { name: "Vanilla Plain", price: "KSh 50", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759665410212_vanill.jpg?alt=media&token=45ba9fb8-d56b-4c47-9e93-f18b1b5ca3f9" }
  ],
  milkshake: [
    { name: "Milk Shake Vanilla Oreo", price: "KSh 180", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759686925756_ice3.jpg?alt=media&token=da9409a6-409d-4167-816f-59fea4698f7a" },
    { name: "Milk Shake Strawberry", price: "KSh 150", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759686997538_strawb.jpg?alt=media&token=34925522-2aad-4dae-b2b1-6a31f0bb5926" },
    { name: "Milk Shake Blueberry", price: "KSh 150", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759687161438_Blueberry.jpg?alt=media&token=d50bc6ae-8645-47b2-804e-8addca8ef1bb" },
    { name: "Milk Shake Chocolate", price: "KSh 150", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759687102324_chmilk.jpg?alt=media&token=05c6350e-6907-4931-820d-d189afad8047" }
  ],
  coffee: [
    { name: "White Coffee", price: "KSh 100", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759931555916_21667-easy-iced-coffee-ddmfs-4x3-0093-7becf3932bd64ed7b594d46c02d0889f.jpg?alt=media&token=b893e54d-fb47-4375-8032-4174ba66a05f" },
    { name: "Coffee", price: "KSh 60", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759665333355_coffee2.jpg?alt=media&token=27e477c0-f2f3-408e-89ca-b87da5f4afd6" }
  ],
  snacks: [
    { name: "Hot Dog", price: "KSh 130", img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2F1759847327273_hot%20dog2.jpg?alt=media&token=2e730134-f7c1-4bc1-a525-5c45b01d970a" }
  ]
};

// --- AI Logic ---
function getAIResponse(input) {
  input = input.toLowerCase();

  if (/(hello|hi|hey|good morning|good afternoon)/.test(input))
    return { text: "Hey there üëã! Welcome to SipDrip ‚Äî home of tasty milkshakes, ice cream, coffee, and snacks! What would you like to try today? üç¶‚òï" };

  if (input.includes('menu') || input.includes('products') || input.includes('price'))
    return { text: showMenu(menu) };

  if (input.includes('ice cream') || input.includes('flavor'))
    return { text: showMenu({ icecream: menu.icecream }) };

  if (input.includes('milkshake') || input.includes('shake'))
    return { text: showMenu({ milkshake: menu.milkshake }) };

  if (input.includes('coffee'))
    return { text: showMenu({ coffee: menu.coffee }) };

  if (input.includes('hot dog') || input.includes('snack'))
    return { text: showMenu({ snacks: menu.snacks }) };

  if (input.includes('best') || input.includes('recommend'))
    return { text: "Our top sellers are the ü•§ <b>Vanilla Oreo Milkshake</b> and üç¶ <b>Mango Ice Cream</b> ‚Äî customers absolutely love them! üòç" };

  if (input.includes('deliver') || input.includes('delivery'))
    return { text: "üöó Yes, we deliver around Eldoret! Just place your order at sipdrip.online and we‚Äôll bring it right to your door." };

  if (input.includes('payment') || input.includes('mpesa') || input.includes('pay'))
    return { text: "üí≥ We accept M-PESA, cash on delivery, or bank transfer  whichever you prefer." };

  if (input.includes('where') || input.includes('located') || input.includes('location'))
    return { text: " We‚Äôre located at <b>Bara c, Varch </b> up stairs." };

  if (input.includes('open') || input.includes('time') || input.includes('hours'))
    return { text: "üïí We‚Äôre open daily from 8:00 AM to 10:00 PM. Come visit us anytime!" };

  if (input.includes('contact') || input.includes('phone') || input.includes('number'))
    return { text: "üìû You can reach us at <b>+254 719 240 049</b>." };

  if (input.includes('offer') || input.includes('discount'))
    return { text: "üéâ Special today: Get 10% off all Milkshakes! Try our Vanilla Oreo flavor while it lasts." };

  // üß† NEW: How to Order FAQ
  if (input.includes('how to order') || input.includes('place order') || input.includes('order process')) {
    return { 
      text: `
        üõí <b>How to Order from SipDrip:</b><br>
        1Ô∏è‚É£ Browse our menu and click <b>"Add to Cart"</b> on your favorite items.<br>
        2Ô∏è‚É£ Click the <b>Cart</b> icon to review your order.<br>
        3Ô∏è‚É£ Fill in your <b>Name</b>, <b>Phone</b>, and <b>Address</b> (if for delivery).<br>
        4Ô∏è‚É£ Choose <b>Delivery</b> or <b>Pickup</b> and add any notes.<br>
        5Ô∏è‚É£ Click <b>Place Order</b> ‚úÖ ‚Äî You‚Äôll get an instant confirmation and a downloadable PDF receipt!<br>
        <br>üéÅ Earn loyalty points every time you order!
      `,
      img: "https://firebasestorage.googleapis.com/v0/b/moviedrift-fcc93.firebasestorage.app/o/products%2Forder-guide.jpg?alt=media&token=example"
    };
  }

  if (input.includes('thank'))
    return { text: "You're welcome üòä! Can I suggest a refreshing shake today?" };

  return { text: "ü§ñ I can help you with our menu, prices, flavors, and how to order. Try asking 'How do I place an order?' üç®" };
}

// --- Menu Renderer ---
function showMenu(categories) {
  let html = '';
  for (const [cat, items] of Object.entries(categories)) {
    html += `<b>${cat.charAt(0).toUpperCase() + cat.slice(1)}:</b><br>`;
    items.forEach(i => {
      html += `
        <div style="margin:8px 0; display:flex; align-items:center; gap:10px;">
          <img src="${i.img}" alt="${i.name}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
          <div><b>${i.name}</b><br><span>${i.price}</span></div>
        </div>`;
    });
  }
  return html;
}

// --- Send Message ---
function sendAIMessage() {
  const text = aiUserInput.value.trim();
  if (!text) return;
  addAIMessage(text, 'user');
  aiUserInput.value = '';
  setTimeout(() => {
    const { text: responseText, img: responseImg } = getAIResponse(text);
    addAIMessage(responseText, 'bot', responseImg);
  }, 600);
}

aiSendBtn.onclick = sendAIMessage;
aiUserInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendAIMessage();
});
</script>


<!-- Floating Call Button -->
<button id="callUsBtn" onclick="window.location.href='tel:+254717436668'"
  style="
    position:fixed;
    bottom:50px;
    left:20px;
    background:#ff4d4d;
    color:#fff;
    border:none;
    border-radius:30px;
    padding:10px 16px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
    z-index:9999;
    transition:0.3s ease;">
  üìû Call Us
</button>

<style>
#callUsBtn:hover { background:#ff6666; transform:translateY(-3px); }
</style>

<div class="products" id="productsGrid"></div>

<!-- Cart Modal -->
<div id="orderModal">
<div class="modal-content">
  <div class="modal-header">Your Cart</div>
  <div class="modal-body">
    <table id="orderTable">
      <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Remove</th></tr></thead>
      <tbody></tbody>
    </table>
    <p style="text-align:right;font-weight:700;">Total: KSh <span id="orderTotal">0.00</span></p>
  </div>
  <div class="modal-footer">
    <button id="proceedCheckoutBtn">Proceed to Checkout</button>
    <button id="closeModalBtn" style="background:#6c757d;margin-left:8px;">Close</button>
  </div>
</div>
</div>

<!-- Checkout Modal -->
<div id="checkoutModal">
<div class="modal-content">
  <div class="modal-header">Checkout Details</div>
  <div class="modal-body">
    <label>Name</label><input type="text" id="customerName" placeholder="Enter your name">
    <label>Phone</label><input type="text" id="customerPhone" placeholder="Enter phone number">
    <label>Delivery Method</label>
    <select id="deliveryMethod">
      <option value="pickup">Pickup (No Fee)</option>
      <option value="delivery">Delivery (+KSh 40 Around Bara c & school)</option>
      <option value="70">Delivery (+KSh 70 Towards Chemundu)</option>
    </select>
    <div id="deliveryAddressContainer" style="display:none;">
      <label>Delivery Address</label>
      <input type="text" id="deliveryAddress" placeholder="Enter your location">
    </div>
    <label>Order Notes / Customization</label>
    <textarea id="orderNotes" placeholder="Add any notes here..."></textarea>
    <p style="font-weight:700;">Total: KSh <span id="checkoutTotal">0.00</span></p>
  </div>
  <div class="modal-footer">
    <button id="placeOrderBtn"></button>
    <!-- WhatsApp order button inserted by script for parity with Place Order -->
    <button id="closeCheckoutBtn" style="background:#6c757d;margin-left:8px;">Cancel</button>
  </div>
</div>
</div>

<!-- Favorites Modal -->
<div id="favoritesModal">
<div class="modal-content">
  <div class="modal-header">Your Favorites</div>
  <div class="modal-body" id="favoritesBody"></div>
  <div class="modal-footer">
    <button onclick="favoritesModal.style.display='none'" style="background:#6c757d;">Close</button>
  </div>
</div>
</div>

<!-- My Orders Modal -->
<div id="myOrdersModal">
<div class="modal-content">
  <div class="modal-header">My Orders</div>
  <div class="modal-body" id="myOrdersBody"></div>
  <div class="modal-footer">
    <button onclick="myOrdersModal.style.display='none'" style="background:#6c757d;">Close</button>
  </div>
</div>
</div>

<!-- Loyalty Points Modal -->
<div id="pointsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div class="modal-content" style="background:#fff; border-radius:16px; overflow:hidden; width:90%; max-width:400px;">
    <div class="modal-header" style="background:#ffd633; color:#333; display:flex; justify-content:space-between; align-items:center;">
      <span style="font-weight:700;">üéÅ Loyalty Points</span>
      <button onclick="document.getElementById('pointsModal').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">‚úñ</button>
    </div>
    <div class="modal-body" style="padding:16px;text-align:center;">
      <p id="pointsInfo" style="font-size:16px;">You have <strong>0</strong> points.</p>
      <button id="redeemPointsBtn" style="background:var(--success);color:#fff;padding:10px;width:100%;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:8px;">
        Redeem 50 Points (KSh 50 Off)
      </button>
      <button onclick="document.getElementById('pointsModal').style.display='none'" style="background:#6c757d;color:#fff;padding:10px;width:100%;border:none;border-radius:8px;cursor:pointer;">Close</button>
      <p style="margin-top:10px;font-size:12px;color:#555;">Earn 1 points per KSh 50 spent. 1 points = KSh 1 off.</p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  addDoc,
  query,
  orderBy,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const { jsPDF } = window.jspdf;

// Firebase config (kept as you provided)
const firebaseConfig = {
  apiKey: "AIzaSyDFVoYWgoxpRBxi3l3OUarvUn2_M9_lqqY",
  authDomain: "moviedrift-fcc93.firebaseapp.com",
  projectId: "moviedrift-fcc93",
  storageBucket: "moviedrift-fcc93.firebasestorage.app",
  messagingSenderId: "794171988540",
  appId: "1:794171988540:web:2e4fce15f2ba1192b98139"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Application state */
let cart = [];
let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
let allProducts = [];

/* Elements*/
const productsGrid = document.getElementById("productsGrid");
const cartCount = document.getElementById("cartCount");
const viewCartBtn = document.getElementById("viewCartBtn");
const orderModal = document.getElementById("orderModal");
const orderTableBody = document.querySelector("#orderTable tbody");
const orderTotal = document.getElementById("orderTotal");
const closeModalBtn = document.getElementById("closeModalBtn");
const proceedCheckoutBtn = document.getElementById("proceedCheckoutBtn");

const checkoutModal = document.getElementById("checkoutModal");
const customerName = document.getElementById("customerName");
const customerPhone = document.getElementById("customerPhone");
const deliveryMethod = document.getElementById("deliveryMethod");
const deliveryAddressContainer = document.getElementById("deliveryAddressContainer");
const deliveryAddress = document.getElementById("deliveryAddress");
const checkoutTotal = document.getElementById("checkoutTotal");
const orderNotes = document.getElementById("orderNotes");
const placeOrderBtn = document.getElementById("placeOrderBtn");
const closeCheckoutBtn = document.getElementById("closeCheckoutBtn");

const favoritesBody = document.getElementById("favoritesBody");
const viewFavoritesBtn = document.getElementById("viewFavoritesBtn");
const viewOrdersBtn = document.getElementById("viewOrdersBtn");

const viewPointsBtn = document.getElementById("viewPointsBtn");
let userPoints = parseInt(localStorage.getItem("loyaltyPoints") || "0");

/* Helpers */
function updateCartCount() { cartCount.textContent = cart.length; }
function getDeliveryChargeVal() {
  if (deliveryMethod.value === "delivery") return 40;
  if (deliveryMethod.value === "70") return 70;
  return 0;
}

/* Render cart */
function renderCart() {
  orderTableBody.innerHTML = "";
  let total = 0;
  cart.forEach((item, index) => {
    total += item.price * item.qty;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.title}</td>
      <td>
        <div class="qty-edit">
          <button onclick="decreaseQty(${index})">-</button>
          <span>${item.qty}</span>
          <button onclick="increaseQty(${index})">+</button>
        </div>
      </td>
      <td>KSh ${(item.price * item.qty).toFixed(2)}</td>
      <td>
        <button style="background:var(--danger);color:#fff;padding:2px 6px;border:none;border-radius:4px;cursor:pointer;" onclick="removeItem(${index})">X</button>
      </td>`;
    orderTableBody.appendChild(tr);
  });
  const deliveryCharge = getDeliveryChargeVal();
  const totalWithDelivery = total + deliveryCharge;
  orderTotal.textContent = totalWithDelivery.toFixed(2);
  checkoutTotal.textContent = totalWithDelivery.toFixed(2);
  updateCartCount();
}

/* Expose helpers to global for inline onclicks used in generated markup */
window.increaseQty = i => { cart[i].qty++; renderCart(); };
window.decreaseQty = i => { if (cart[i].qty > 1) { cart[i].qty--; renderCart(); } };
window.removeItem = i => { cart.splice(i, 1); renderCart(); };

/* Delivery toggle */
deliveryMethod.addEventListener("change", () => {
  deliveryAddressContainer.style.display = deliveryMethod.value === "delivery" ? "block" : (deliveryMethod.value === "70" ? "block" : "none");
  renderCart();
});

/* Checkout modal close */
closeCheckoutBtn.addEventListener("click", () => { checkoutModal.style.display = "none"; });

/* Add WhatsApp button next to Place Order (but we will handle saving to Firestore first) */
const placeOrderWhatsappBtn = document.createElement("button");
placeOrderWhatsappBtn.id = "placeOrderWhatsappBtn";
placeOrderWhatsappBtn.textContent = "Place Order via WhatsApp";
placeOrderWhatsappBtn.className = "whatsapp-btn";
placeOrderBtn.parentNode.insertBefore(placeOrderWhatsappBtn, placeOrderBtn.nextSibling);

/* WhatsApp + Firestore flow:
   1) Validate fields & cart
   2) Build orderData (same structure as Place Order)
   3) Save to Firestore with source: 'whatsapp'
   4) Then open WhatsApp link with the same message
   5) Reset UI
*/
placeOrderWhatsappBtn.addEventListener("click", async () => {
  try {
    const name = customerName.value.trim();
    const phone = customerPhone.value.trim();
    const method = deliveryMethod.value;
    const address = deliveryAddress.value.trim();
    const notes = orderNotes.value.trim();
    const total = parseFloat(checkoutTotal.textContent) || 0;
    const deliveryCharge = getDeliveryChargeVal();

    if (!name || !phone || cart.length === 0) {
      alert("Please enter your name, phone, and have at least one item in the cart.");
      return;
    }

    // Build order payload
    const orderCode = "ORD-" + Date.now();
    const orderData = {
      code: orderCode,
      items: cart.map(i => ({ id: i.id || null, title: i.title, price: i.price, qty: i.qty, image: i.image || '' })),
      subtotal: cart.reduce((s, i) => s + i.price * i.qty, 0),
      deliveryCharge,
      total: total,
      customer: {
        name,
        phone,
        delivery: method,
        address: address || ""
      },
      notes: notes || "",
      status: "Pending",
      source: "whatsapp",
      date: new Date()
    };

    // Save to Firestore first (so admin sees it immediately)
    await addDoc(collection(db, "orders"), orderData);

    // Build professional WhatsApp message
    let message = `üõí *New Order Received*\n`;
    message += `*Code:* ${orderCode}\n`;
    message += `*Customer:* ${name}\n`;
    message += `*Phone:* ${phone}\n`;
    message += `*Delivery Method:* ${method}${address ? `\n*Address:* ${address}` : ''}\n`;
    message += `*Delivery Charge:* KSh ${deliveryCharge}\n`;
    if (notes) message += `*Notes:* ${notes}\n`;
    message += `\n*Order Details:*\n`;
    cart.forEach(item => {
      message += `‚Ä¢ ${item.title} x${item.qty} - KSh ${(item.price * item.qty).toFixed(2)}\n`;
    });
    message += `\n*Total:* KSh ${total}\n`;
    message += `\nThank you for your order!`;

    const businessNumber = "254102949969"; // replace with your WhatsApp number
    const whatsappURL = `https://wa.me/${businessNumber}?text=${encodeURIComponent(message)}`;

    // Open WhatsApp in new tab/window
    window.open(whatsappURL, "_blank");

    // Provide user feedback and reset
    alert("‚úÖ Your order has been recorded and WhatsApp will open now. Thank you!");
    cart = [];
    renderCart();
    checkoutModal.style.display = "none";
    customerName.value = "";
    customerPhone.value = "";
    deliveryAddress.value = "";
    orderNotes.value = "";

    // Update loyalty points (same as placeOrder)
    const earnedPoints = Math.floor(orderData.subtotal / 50);
    userPoints += earnedPoints;
    localStorage.setItem("loyaltyPoints", userPoints);
    alert(`üéÅ You earned ${earnedPoints} points! You now have ${userPoints} total.`);

  } catch (err) {
    console.error("Error sending WhatsApp order:", err);
    alert("Failed to record the WhatsApp order. Please try again.");
  }
});

/* Place order (regular button) ‚Äî unchanged behavior, saves to Firestore and generates PDF */
placeOrderBtn.addEventListener("click", async () => {
  if (!customerName.value || !customerPhone.value || (deliveryMethod.value === "delivery" && !deliveryAddress.value)) {
    alert("Please fill all required fields!");
    return;
  }

  const orderCode = "ORD-" + Date.now();
  const totalValue = cart.reduce((s, i) => s + i.price * i.qty, 0) + (deliveryMethod.value === "delivery" ? 40 : (deliveryMethod.value === "70" ? 70 : 0));

  const orderData = {
    code: orderCode,
    items: cart.map(i => ({ id: i.id || null, title: i.title, price: i.price, qty: i.qty, image: i.image || '' })),
    subtotal: cart.reduce((s, i) => s + i.price * i.qty, 0),
    deliveryCharge: (deliveryMethod.value === "delivery" ? 40 : (deliveryMethod.value === "70" ? 70 : 0)),
    total: totalValue,
    customer: {
      name: customerName.value,
      phone: customerPhone.value,
      delivery: deliveryMethod.value,
      address: deliveryAddress.value || ""
    },
    notes: orderNotes.value || "",
    status: "Pending",
    source: "web",
    date: new Date()
  };

  try {
    await addDoc(collection(db, "orders"), orderData);
    alert("‚úÖ Order submitted!");

    // Add loyalty points
    const earnedPoints = Math.floor(orderData.subtotal / 50);
    userPoints += earnedPoints;
    localStorage.setItem("loyaltyPoints", userPoints);
    alert(`üéÅ You earned ${earnedPoints} points! You now have ${userPoints} total.`);

    // PDF generation
    const doc = new jsPDF();
    doc.setFontSize(18); doc.text("SIP & DRIP Fast Food & Ice Cream", 14, 20);
    doc.setFontSize(12); doc.text(`Order Receipt`, 14, 30);
    doc.text(`Order Code: ${orderCode}`, 14, 38);
    doc.text(`Name: ${customerName.value}`, 14, 46);
    doc.text(`Phone: ${customerPhone.value}`, 14, 54);
    doc.text(`Delivery: ${deliveryMethod.value}`, 14, 62);
    if (deliveryMethod.value === "delivery") doc.text(`Address: ${deliveryAddress.value}`, 14, 70);
    doc.text(`Notes: ${orderNotes.value || "N/A"}`, 14, 78);
    let y = 86; doc.text("Items:", 14, y);
    cart.forEach(item => { y += 8; doc.text(`- ${item.title} x ${item.qty} = KSh ${(item.price * item.qty).toFixed(2)}`, 18, y); });
    y += 10; doc.text(`Total: KSh ${totalValue.toFixed(2)}`, 14, y); y += 8; doc.text("Thank you for your order!", 14, y);
    doc.save(`${orderCode}.pdf`);

    // Reset
    cart = [];
    renderCart();
    checkoutModal.style.display = "none";
    customerName.value = "";
    customerPhone.value = "";
    deliveryAddress.value = "";
    orderNotes.value = "";

  } catch (err) {
    console.error("Place order error:", err);
    alert("Failed to place order: " + (err.message || err));
  }
});

/* Favorites modal functionality */
viewFavoritesBtn.addEventListener("click", () => {
  favoritesBody.innerHTML = "";
  if (favorites.length === 0) {
    favoritesBody.innerHTML = "<p>No favorites yet.</p>";
    favoritesModal.style.display = "flex";
    return;
  }
  favorites.forEach((f, i) => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <img src="${f.image}" style="width:60px;height:60px;border-radius:10px;margin-right:10px;">
      <span style="flex:1;">${f.title}</span>
      <button onclick="addFavToCart(${i})" style="background:var(--accent);color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;margin-right:6px;">Add to Cart</button>
      <button onclick="removeFavorite(${i})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;">Remove</button>
    `;
    favoritesBody.appendChild(div);
  });
  favoritesModal.style.display = "flex";
});

/* Add favorite item to cart */
window.addFavToCart = i => {
  const f = favorites[i];
  const existing = cart.find(c => c.id === f.id);
  if (existing) existing.qty++;
  else cart.push({ id: f.id, title: f.title, price: f.price, qty: 1, image: f.image });
  renderCart();
  alert("‚úÖ Added from favorites!");
};

/* Remove favorite */
window.removeFavorite = i => {
  if (!confirm("Remove this item from favorites?")) return;
  favorites.splice(i, 1);
  localStorage.setItem("favorites", JSON.stringify(favorites));
  viewFavoritesBtn.click();
};

/* My Orders modal - allow customer to check by phone */
viewOrdersBtn.addEventListener("click", () => {
  const phone = prompt("Enter your phone number to view your orders:");
  if (!phone) return;
  myOrdersBody.innerHTML = "";
  const q = query(collection(db, "orders"), orderBy("date", "desc"));
  onSnapshot(q, snapshot => {
    myOrdersBody.innerHTML = "";
    snapshot.forEach(docSnap => {
      const o = docSnap.data();
      if (!o.customer || o.customer.phone !== phone) return;
      const div = document.createElement("div");
      div.style.border = "1px solid #ddd";
      div.style.padding = "10px";
      div.style.marginBottom = "8px";
      div.style.borderRadius = "12px";
      let itemsHtml = (o.items || []).map(i => `
        <div style="display:flex;align-items:center;margin-bottom:4px;">
          <img src="${i.image || ''}" style="width:50px;height:50px;border-radius:8px;margin-right:8px;">
          <span>${i.title} x ${i.qty}</span>
        </div>
      `).join("");
      div.innerHTML = `<p><strong>Code:</strong> ${o.code}</p>
        <div><strong>Items:</strong>${itemsHtml}</div>
        <p><strong>Total:</strong> KSh ${Number(o.total || 0).toFixed(2)}</p>
        <p><strong>Status:</strong> ${o.status}</p>
        <button onclick="downloadOrder('${o.code}',${JSON.stringify(o.items || [])},${Number(o.total||0)},'${(o.customer||{}).name||''}','${(o.customer||{}).phone||''}','${(o.customer||{}).delivery||''}','${(o.customer||{}).address||''}','${o.notes||''}')"
        style="background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:6px;margin-right:6px;">Download PDF</button>
        <button onclick="cancelOrder('${docSnap.id}')" style="background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:6px;">Cancel</button>`;
      myOrdersBody.appendChild(div);
    });
  });
  myOrdersModal.style.display = "flex";
});

/* Download order - same as earlier */
window.downloadOrder = (code, items, total, name, phone, delivery, address, notes) => {
  const doc = new jsPDF();
  doc.setFontSize(18); doc.text("üçî Fast Food & Ice Cream", 14, 20);
  doc.setFontSize(12); doc.text("Order Receipt", 14, 30);
  doc.text(`Order Code: ${code}`, 14, 38);
  doc.text(`Name: ${name}`, 14, 46);
  doc.text(`Phone: ${phone}`, 14, 54);
  doc.text(`Delivery: ${delivery}`, 14, 62);
  if (delivery === "delivery") doc.text(`Address: ${address}`, 14, 70);
  doc.text(`Notes: ${notes || "N/A"}`, 14, 78);
  let y = 86;
  doc.text("Items:", 14, y);
  (items || []).forEach(item => {
    y += 8;
    doc.text(`- ${item.title} x ${item.qty}`, 18, y);
  });
  y += 10;
  doc.text(`Total: KSh ${Number(total || 0).toFixed(2)}`, 14, y);
  y += 8;
  doc.text("Thank you for your order!", 14, y);
  doc.save(`${code}.pdf`);
};

/* Cancel order */
window.cancelOrder = async id => {
  if (!confirm("Are you sure you want to cancel this order?")) return;
  await deleteDoc(doc(db, "orders", id));
  alert("Order canceled.");
};

/* Search & category filter */
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
searchInput.addEventListener("input", filterProducts);
categoryFilter.addEventListener("change", filterProducts);
function filterProducts(){
  const search = searchInput.value.toLowerCase();
  const category = categoryFilter.value;
  let filtered = allProducts.filter(p => p.title.toLowerCase().includes(search));
  if (category !== "all") filtered = filtered.filter(p => p.category === category);
  renderProducts(filtered);
}

/* Load products from Firestore */
onSnapshot(collection(db, "products"), snapshot => {
  allProducts = [];
  snapshot.forEach(docSnap => {
    const p = { ...docSnap.data(), id: docSnap.id };
    allProducts.push(p);
  });
  renderProducts(allProducts);
});

/* Render products grid */
function renderProducts(products){
  productsGrid.innerHTML = "";
  products.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <img src="${p.image || ''}" alt="${p.title}">
      <div class="product-info">
        <h4>${p.title}</h4>
        <p>KSh ${p.price}</p>
        <div class="qty-container"><button onclick="decreaseQtyCard(this)">-</button><span>1</span><button onclick="increaseQtyCard(this)">+</button></div>
        <button class="add-cart">Add to Cart</button>
        <button class="add-fav" style="margin-top:6px;background:#ffd633;color:#333;border:none;padding:6px 12px;border-radius:10px;font-weight:700;cursor:pointer;">‚≠ê Favorite</button>
      </div>
    `;
    let qtySpan = card.querySelector(".qty-container span");
    card.querySelector(".add-cart").addEventListener("click", () => {
      const qty = parseInt(qtySpan.textContent);
      const existing = cart.find(i => i.id === p.id);
      if (existing) existing.qty += qty;
      else cart.push({ id: p.id, title: p.title, price: Number(p.price || 0), qty, image: p.image || '' });
      renderCart();
      alert("‚úÖ Added to cart!");
    });
    card.querySelector(".add-fav").addEventListener("click", () => {
      if (!favorites.find(f => f.id === p.id)) {
        favorites.push({ id: p.id, title: p.title, price: p.price, image: p.image });
        localStorage.setItem("favorites", JSON.stringify(favorites));
        alert("‚≠ê Added to favorites!");
      } else {
        alert("Already in favorites!");
      }
    });
    productsGrid.appendChild(card);
  });
}

/* card qty helpers */
window.increaseQtyCard = btn => { let span = btn.parentElement.querySelector("span"); span.textContent = parseInt(span.textContent) + 1; }
window.decreaseQtyCard = btn => { let span = btn.parentElement.querySelector("span"); if (parseInt(span.textContent) > 1) span.textContent = parseInt(span.textContent) - 1; }

/* Cart modal handlers */
viewCartBtn.addEventListener("click", () => { orderModal.style.display = "flex"; renderCart(); });
closeModalBtn.addEventListener("click", () => { orderModal.style.display = "none"; });
proceedCheckoutBtn.addEventListener("click", () => {
  orderModal.style.display = "none";
  checkoutModal.style.display = "flex";
  checkoutTotal.textContent = cart.reduce((s, i) => s + i.price * i.qty, 0).toFixed(2);
});

/* Loyalty points UI */
viewPointsBtn.addEventListener("click", () => {
  document.getElementById("pointsInfo").innerHTML = `You have <strong>${userPoints}</strong> points.`;
  document.getElementById("pointsModal").style.display = "flex";
});
document.getElementById("redeemPointsBtn").addEventListener("click", () => {
  if (userPoints < 50) { alert("‚ö†Ô∏è You need at least 50 points to redeem!"); return; }
  userPoints -= 50;
  localStorage.setItem("loyaltyPoints", userPoints);
  alert("üéâ You redeemed 50 points for a KSh 50 discount!");
  document.getElementById("pointsInfo").innerHTML = `You have <strong>${userPoints}</strong> points.`;
});


</script>
</body>
</html>
